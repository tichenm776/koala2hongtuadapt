# H5访客预约--移动端API--后端逻辑说明

---

修改记录：

| 版本号 | 修改人 |  修改日期  | 修改内容 |
| :----: | :----: | :--------: | -------- |
|  V1.0  | 雷振林 | 2021/05/23 | 创建     |
| V1.0.1 | 雷振林 | 2021/06/02 | 增加员工绑定的考拉调用接口说明 |

---
目录

[TOC]

---

# 说明
接口传入、返回均为JSON数据

## 1 员工查询微信是否已绑定</span>

**调用URL:**
/v1/subject/binding

**调用方法：**
GET

**后端逻辑说明**

（1）调用现成的微信接口云服务的接口：2.1 查询微信是否已绑定（GET /v2/wechat/binding）

（2）如果未绑定，返回未绑定信息

（3）如果已绑定，用（1）中返回的手机号码，调用考拉函数（koala_api/GetStaffs）去内部考拉系统，获取该手机号码对应的员工的ID、头像、部门返回。其中头像数据需在云端落地，并返回可直接访问的url



## 1.1 员工微信绑定

**调用URL:**
/v1/subject/binding

**调用方法：**
POST

**后端逻辑说明**

（1）调用现成的微信接口云服务的微信绑定接口：2.2 微信绑定（POST /v2/wechat/binding）

（2）去内部考拉系统，根据员工姓名和手机号，调用考拉函数（koala_api/GetStaffs）查询改员工是否存在，获取该手机号码对应的员工的ID、头像、部门返回。其中头像数据需在云端落地，并返回可直接访问的url




## 2 查询访客微信是否已绑定
**调用URL:**
/v1/visitor/binding

**调用方法：**
GET

**后端逻辑说明：**

（1）调用现成的微信接口云服务的接口：2.1 查询微信是否已绑定（GET /v2/wechat/binding）

（2）如果未绑定，返回未绑定信息

（3）若已绑定，返回已绑定的微信昵称、微信头像、手机号码，返回



## 2.1 访客微信绑定
**调用URL:**
/v1/visitor/binding

**调用方法：**
POST

**后端逻辑说明：**

（1）调用现成的微信接口云服务的微信绑定接口：2.2 微信绑定（POST /v2/wechat/binding）

（2）读取绑定的微信昵称、微信头像、手机号码，返回



## 3 <span id="3">访客申请（员工或访客）</span>

**调用URL:**
/v1/subject

**调用方法：**
POST

**后端逻辑说明：**

（1）记录在数据库，不提交给内部考拉系统

（2）对于员工申请的记录（申请人的手机号码==被访人手机号码），需要给访客的手机号码，发送申请成功微信（微信接口云服务）和短信（阿里云短信），对于每一位随行人员都需要发送微信和短信

（3）对于访客申请的记录（申请人的手机号码==访客手机号码），需要给被访人的手机号码，发送微信（微信接口云服务）和短信（阿里云短信），通知授权。 给申请人的手机号码，发送微信和短信，提示申请成功等待授权

（4）对于员工申请的记录，无需再授权（授权标志置"已授权"），对于访客申请的记录，需要授权（授权标志置"未授权"）



## 4 选择来访目的

**调用URL:**
/v1/subject/purpose

**调用方法：**
GET

**后台逻辑说明：**

（1）去内部考拉系统，读取来访目的（koala_api/GetPurpose），返回给前端

## 5 查询访客申请记录（员工或访客用户，都用本接口）

**调用URL:**
/v1/visit/records

**调用方法：**
GET

**后台逻辑说明**
（1）返回的数据，以时间倒序排序

（2）根据传上来的参数phone（员工的手机号码），查询被访人手机号码是他、但是申请人手机号码不是他的申请记录

## 6 员工查询授权记录

**调用URL:**
/v1/auth/records

**调用方法：**
GET

**后台逻辑说明：**

（1）根据传上来的参数proposer（申请人的手机号码），查询属于他的申请记录

（2）返回的数据，以时间倒序排序

## 7 员工授权

**调用URL:**
/v1/auth/<id>

<id>是本条访客申请记录的id

**调用方法：**
PUT

**后台逻辑说明：**
（1）将指定id的申请记录，进行授权（授权标志置"已授权"）

